@using openBasculaNet.Core.Structures;
@{
    ViewBag.Title = "Principal";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2></h2>
<input type="hidden" id="hdfIdTransito" name="hdfIdTransito" value="-1" />
<input type="hidden" id="hdfNumAlbaran" name="hdfNumAlbaran" value="-1" />

<div class="row  margin-arriba">
    <button type="button" class="col-md-2 btn btn-default btn-openBascula  " onclick="GuardarTransito()"><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span>&nbsp; GUARDAR</button>
    
    <button type="button" class="col-md-offset-1 col-md-2 btn btn-default btn-openBascula" onclick="verEnTransito()"><span class="glyphicon glyphicon-inbox" aria-hidden="true"></span>&nbsp; EN TRANSITO</button>
    <button type="button" class="col-md-offset-5 col-md-2 btn btn-default btn-openBascula" onclick="imprimirTransito()"><span class="glyphicon glyphicon-print" aria-hidden="true"></span>&nbsp; IMPRIMIR</button>
</div>
<hr />
<div class="row  margin-arriba">
    <label class="col-md-2">CABINA</label>
    <input type="text" class="col-md-3 text-uppercase" id="txtCabina" />
    <label class="col-md-offset-2 col-md-2">REMOLQUE</label>
    <input type="text" class="col-md-3 text-uppercase" id="txtRemolque" />
</div>
<div class="row  margin-arriba">
    <label class="col-md-offset-7 col-md-1">ENTRADA</label>
    <button type="button" class="col-md-1 btn btn-default btn-openBascula" onclick="PonerHoraEntrada()">
        <span class="glyphicon glyphicon-time" aria-hidden="true"></span>
        <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
    </button>
    <!--<div id="dtp_fecha_entrada" class='input-group date col-md-3' data-dbvalue="null">
        <span class="input-group-addon">
            <span class="glyphicon glyphicon-calendar"></span>
        </span>
        <input type='text' class="datepicker form-control" id="dtp_fecha_entrada_value" />
    </div>
    -->
    <input type="text" class="col-md-3 text-uppercase" id="txtEntrada"  />   
</div>
<div class="row  margin-arriba">
    <label class="col-md-2">PRODUCTO</label>
    <input type="text" class="col-md-9 text-left" id="txtPRODUCTO" data-id=""/>
    <button type="button" class="col-md-1 btn btn-default  btn-openBascula" onclick="abrirBuscador('@Enumeraciones.TipoBuscador.PRODUCTO.ToString()')"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
</div>
<div class="row  margin-arriba">
    <label class="col-md-2">CLIENTE</label>
    <input type="text" class="col-md-9 text-left" id="txtCLIENTE" data-id="" />
    <button type="button" class="col-md-1 btn btn-default  btn-openBascula" onclick="abrirBuscador('@Enumeraciones.TipoBuscador.CLIENTE.ToString()')"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
</div>
<div class="row  margin-arriba">
    <label class="col-md-2">PROVEEDOR</label>
    <input type="text" class="col-md-9 text-left" id="txtPROVEEDOR" data-id="" />
    <button type="button" class="col-md-1 btn btn-default  btn-openBascula" onclick="abrirBuscador('@Enumeraciones.TipoBuscador.PROVEEDOR.ToString()')"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
</div>
<div class="row  margin-arriba">
    <label class="col-md-2">AGENCIA</label>
    <input type="text" class="col-md-9 text-left" id="txtAGENCIA" data-id="" />
    <button type="button" class="col-md-1 btn btn-default  btn-openBascula" onclick="abrirBuscador('@Enumeraciones.TipoBuscador.AGENCIA.ToString()')"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
</div>
<div class="row  margin-arriba">
    <label class="col-md-2">POSEEDOR</label>
    <input type="text" class="col-md-9 text-left" id="txtPOSEEDOR" data-id=""/>
    <button type="button" class="col-md-1 btn btn-default  btn-openBascula" onclick="abrirBuscador('@Enumeraciones.TipoBuscador.POSEEDOR.ToString()')"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
</div>
<div class="row  margin-arriba">
    <label class="col-md-2">CONDUCTOR</label>
    <input type="text" class="col-md-9 text-left" id="txtCONDUCTOR" data-id=""/>
    <button type="button" class="col-md-1 btn btn-default  btn-openBascula" onclick="abrirBuscador('@Enumeraciones.TipoBuscador.CONDUCTOR.ToString()')"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
</div>
<div class="row  margin-arriba">
    <label class="col-md-2">ORIGEN</label>
    <input type="text" class="col-md-9 text-left" id="txtORIGEN" data-id=""/>
    @*<button type="button" class="col-md-1 btn btn-default  btn-openBascula" onclick="abrirBuscador('@Enumeraciones.TipoBuscador.ORIGEN.ToString()')"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>*@
</div>
<div class="row  margin-arriba">
    <label class="col-md-2">DESTINO</label>
    <input type="text" class="col-md-9 text-left" id="txtDESTINO" data-id=""/>
    @*<button type="button" class="col-md-1 btn btn-default  btn-openBascula" onclick="abrirBuscador('@Enumeraciones.TipoBuscador.DESTINO.ToString()')"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>*@
</div>
<div class="row  margin-arriba">
    <label class="col-md-2">kg. ENTRADA</label>
    <input type="text" class="col-md-3" id="txtPesoEntrada" />    
</div>
<div class="row  margin-arriba">
    <label class="col-md-2">kg. SALIDA</label>
    <input type="text" class="col-md-3" id="txtPesoSalida" />    
</div>
<div class="row  margin-arriba">
    <label class="col-md-2">NETO</label>
    <input type="text" class="col-md-3" id="txtPesoNeto" readonly="readonly" />
</div>

<script type="text/javascript">
        var ESTADO_GUARDADO = "FIN";

        window.onload = thisEndLoad;
        function thisEndLoad() {          

            /*iniciamos el resto de valores*/
            $('[id*="dtp_"]').each(function () {
                if ($(this).attr('id').indexOf('_value') == -1) {
                    var idFecha = '#' + $(this).attr('id');
                    // $(idFecha).data("DateTimePicker").locale('es');
                    if ($(idFecha).data('dbvalue') !== '') {
                        var fecha = dateOrNull($(idFecha).data('dbvalue'));
                        setFechaPara(idFecha, fecha);
                    }
                    else setFechaPara(idFecha, null);
                }
            });

            LimpiarCampos();
            $('#txtPesoEntrada').on('keyup', function () { calcularNETO(); });
            $('#txtPesoSalida').on('keyup', function () { calcularNETO(); });
        }

        function verEnTransito() {
            var url = "/Home/VehiculosEnTransito";
            LaunchModal('Vehiculos en transito', url);
        }

        function cargarTransitoDesdeJSON(modelo) {
            LimpiarCampos();
            $('#hdfIdTransito').val(modelo.data.ID_TRANSITO);
            $('hdfNumAlbaran').val(modelo.data.NUM_ALBARAN);
            $('#txtCabina').val(modelo.data.MAT_CABINA);
            $('#txtRemolque').val(modelo.data.MAT_REMOLQUE);
            $('#txtEntrada').val( getDateWithTime(modelo.data.FECHA_ENTRADA));   

            //ids
            $('#txtPRODUCTO').data('id', modelo.data.ID_PRODUCTO);
            $('#txtPOSEEDOR').data('id', modelo.data.ID_POSEEDOR);
            $('#txtPROVEEDOR').data('id', modelo.data.ID_PROVEEDOR);
            $('#txtAGENCIA').data('id', modelo.data.ID_AGENCIA);
            $('#txtCLIENTE').data('id', modelo.data.ID_CLIENTE);
            $('#txtCONDUCTOR').data('id', modelo.data.ID_CONDUCTOR);
            //textos a mostrar
            $('#txtPRODUCTO').val(modelo.TEXTO_PRODUCTO);
            $('#txtPOSEEDOR').val(modelo.TEXTO_POSEEDOR);
            $('#txtPROVEEDOR').val(modelo.TEXTO_PROVEEDOR);
            $('#txtAGENCIA').val(modelo.TEXTO_AGENCIA);
            $('#txtCLIENTE').val(modelo.TEXTO_CLIENTE);
            $('#txtCONDUCTOR').val(modelo.TEXTO_CONDUCTOR);

            $('#txtORIGEN').val(modelo.data.ORIGEN);
            $('#txtDESTINO').val(modelo.data.DESTINO);

            $('#txtPesoEntrada').val(modelo.data.PESO_ENTRADA);
            $('#txtPesoSalida').val(modelo.data.PESO_SALIDA);
            $('#txtPesoNeto').val(modelo.data.NETO);
            calcularNETO();
        }

        function GuardarTransito() {
            var jsonTransito = {
                "ID_TRANSITO": parseInt($('#hdfIdTransito').val()),
                "NUM_ALBARAN": $('hdfNumAlbaran').val(),
                "MAT_CABINA": $('#txtCabina').val(),
                "MAT_REMOLQUE": $('#txtRemolque').val(),
                "FECHA_ENTRADA": $('#txtEntrada').val(),
                "FECHA_SALIDA": null,
                "PESO_ENTRADA": $('#txtPesoEntrada').val(),
                "PESO_SALIDA": $('#txtPesoSalida').val(),
                "NETO": $('#txtPesoNeto').val(),
                "IVA_APLICABLE": null,
                "IMPORTE_FINAL": null,
                "IMPORTE_PRODUCTO": null,
                "ID_PRODUCTO": $('#txtPRODUCTO').data('id'),
                "ID_CLIENTE": $('#txtCLIENTE').data('id'),
                "ID_PROVEEDOR": $('#txtPROVEEDOR').data('id'),
                "ID_AGENCIA": $('#txtAGENCIA').data('id'),
                "ID_POSEEDOR": $('#txtPOSEEDOR').data('id'),
                "ID_CONDUCTOR": $('#txtCONDUCTOR').data('id'),
                "ORIGEN": $('#txtORIGEN').val(),
                "DESTINO": $('#txtDESTINO').val()
            };

            var cabina = replaceAll(' ', '', jsonTransito.MAT_CABINA);
            console.log(cabina.length);
            if (cabina.length != 0) {
                $.ajax({
                    type: "PUT",
                    url: '/API/openBascula/GuardarTransito?fechaEntrada=' + $('#txtEntrada').val(),
                    data: jsonTransito,
                    async: true,
                    dataType: "json",
                    headers: {
                        "Accept": "application/json"
                    },
                    success: function (data) {
                        if (data === true) {
                            LaunchModalMensajes("Guardado correcto", "Guardado");
                            LimpiarCampos();
                        }
                        else {
                            //error
                            LaunchModalMensajesError("Error al guardar", "Guardado fallido");
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log(errorThrown);
                    }
                });
            }
            else {
                LaunchModalMensajesError("Error al guardar", "Debe rellenar al menos el campo CABINA");
            }
        }

        function LimpiarCampos() {
            $('#hdfIdTransito').val(-1);
            $('hdfNumAlbaran').val(-1);
            $('#txtCabina').val('');
            $('#txtRemolque').val('');
            $('#txtEntrada').val('');
            $('#txtORIGEN').val('');
            $('#txtDESTINO').val('');            

            $('#txtPRODUCTO').val('');
            $('#txtPROVEEDOR').val('');
            $('#txtPOSEEDOR').val('');
            $('#txtAGENCIA').val('');
            $('#txtCONDUCTOR').val('');
            $('#txtCLIENTE').val('');

            $('#txtPesoEntrada').val('');
            $('#txtPesoSalida').val('');
            $('#txtPesoNeto').val('');
        }

        function calcularNETO() {
            var p1 = isNaN($('#txtPesoEntrada').val()) || $('#txtPesoEntrada').val() == null ? 0 : parseInt($('#txtPesoEntrada').val());
            var p2 = isNaN($('#txtPesoSalida').val()) || $('#txtPesoSalida').val() == null ? 0 : parseInt($('#txtPesoSalida').val());
            var neto = 0;

            if (p1 >= p2) {
                neto = p1 - p2;                
            }
            else {
                neto = p2 - p1  
            }

            if (isNaN(neto)) $('#txtPesoNeto').val('');
            else $('#txtPesoNeto').val(neto);            
        }

        function PonerHoraEntrada() {
            $('#txtEntrada').val(getDateWithTimeNow());
        }

        function abrirBuscador(tipo) {
            var url = "/Home/Buscador?tipoBusqueda=" + tipo;
            LaunchModal('Buscador', url);
        }

        /**
         * Se encarga de finalizar e imprmir el transito 
         */
        function imprimirTransito() {
            if ($('#hdfIdTransito').val() === '-1') {
                LaunchModalMensajes("Seleccione un transito ", "Error al ver informe");
            }
            else {
                var url = '/Reports/index.aspx?report=informeAlbaran.rdlc&openBasculaViewName=informeAlbaranReport&idTransito=' + $('#hdfIdTransito').val();
                LaunchModal('Albaran de transito', url);
            }
        }
</script>